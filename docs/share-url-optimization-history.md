# シェア機能 URL長さ調整の履歴レポート

## 概要

QuizAppのシェア機能において、URL長が長すぎる問題（URI Too Long エラー）に対応した履歴をまとめる。

---

## 問題の背景

- 教材の本文（content）が大きいと、LZ-String圧縮後もURLが2000文字を超過
- ブラウザ/サーバーで「URI Too Long」エラーが発生
- QRコードリーダーで読み取れないケースも発生

---

## 対応履歴（時系列）

### 1. 共有URLサイズの大幅削減
**コミット:** `1be03e8`
**日時:** 2025-11-15 12:31:55

**対策内容:**
| 項目 | 内容 |
|------|------|
| contentフィールド除外 | URLサイズ **70-90%削減** |
| URL長チェック機能 | 2000文字超で警告表示 |
| フォールバック処理 | インポート時に要約から本文を自動生成 |

**コード変更（app.js）:**
```javascript
// Before: contentを含む
const shareData = {
  material: { title, summary, content, tags, fileName }
};

// After: contentを除外
const shareData = {
  material: { title, summary, /* content除外 */ tags, fileName }
};
```

---

### 2. GitHub Gist共有への移行（試行）
**コミット:** `3125152`
**日時:** 2025-11-15 12:47:52

**対策内容:**
- URLベースから外部サービス（GitHub Gist API）への移行を試行
- 短いURL（`?gist=abc123`）で無制限のデータサイズに対応

**メリット:**
- データサイズ制限なし（30問以上も可能）
- 永続的に保存

**問題点:**
- 後にCORSエラーが発生し、LZ-string方式に戻すことに

---

### 3. LZ-string方式への回帰とシェア機能改善
**コミット:** `6178c3c`
**日時:** 2025-11-15 13:52:09

**対策内容:**
| 項目 | 内容 |
|------|------|
| dpaste.orgのCORSエラー回避 | LZ-string圧縮URLに戻す |
| URL長警告機能 | 2000文字以上で警告、8000文字以上でエラー |
| 解説文の短縮 | GPTプロンプトで200-300文字厳守に変更 |

---

### 4. URL長削減の最終調整
**コミット:** `0e6a7b9`
**日時:** 2025-11-15 15:03:29

**対策内容:**
| 項目 | Before | After |
|------|--------|-------|
| 解説文（共有時） | 全文 | 最初の100文字に短縮 |
| URL長警告閾値 | 2000文字 | 5000文字に緩和 |
| URL長上限 | - | 10000文字に拡大 |
| 推定URL長 | 14876文字 | **3000-5000文字** |

---

## 最終的なアーキテクチャ

```
┌─────────────────────────────────────────────────────────┐
│                    共有データ構造                        │
├─────────────────────────────────────────────────────────┤
│ material: {                                              │
│   title: string,                                         │
│   summary: string,                                       │
│   // content: 除外（URL長削減）                          │
│   tags: string[],                                        │
│   fileName: string                                       │
│ }                                                        │
│ questions: [{                                            │
│   question: string,                                      │
│   choices: string[4],                                    │
│   correctIndex: number,                                  │
│   explanation: string (共有時は100文字に短縮),          │
│   difficulty: string                                     │
│ }]                                                        │
└─────────────────────────────────────────────────────────┘
           ↓
    JSON.stringify()
           ↓
    LZString.compressToEncodedURIComponent()
           ↓
    ?share={compressed_data}
```

---

## 削減効果まとめ

| 施策 | 削減率 |
|------|--------|
| contentフィールド除外 | 70-90% |
| 解説文の短縮（100文字） | 追加削減 |
| **合計** | **約80%以上削減** |

---

## 関連コミット一覧

| コミット | 日時 | 内容 |
|----------|------|------|
| `1be03e8` | 11/15 12:31 | 共有URLサイズ大幅削減 |
| `3125152` | 11/15 12:47 | GitHub Gist共有に移行 |
| `6178c3c` | 11/15 13:52 | LZ-string方式に回帰 |
| `0e6a7b9` | 11/15 15:03 | URL長削減の最終調整 |

---

## 今後の検討事項

1. **外部ストレージの再検討**: Supabase Storageを使った共有方式
2. **短縮URL生成**: 独自の短縮URLサービス構築
3. **QRコードサイズ最適化**: 大きいQRコードでも読み取れるUI改善
