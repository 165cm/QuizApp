<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>科学的勉強法クイズアプリ</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.5.0/lz-string.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/davidshimjs-qrcodejs@0.0.2/qrcode.min.js"></script>
</head>
<body>
    <div id="app">
        <!-- シェア専用LP画面 -->
        <div id="shared-quiz-landing" class="screen">
            <div class="landing-container">
                <div class="landing-hero">
                    <div class="landing-icon">🎓</div>
                    <h1 class="landing-title" id="shared-quiz-title">クイズに挑戦</h1>
                    <p class="landing-description" id="shared-quiz-description">
                        友達から共有されたクイズです。<br>
                        あなたの知識を試してみましょう！
                    </p>
                    <div class="landing-stats">
                        <div class="landing-stat">
                            <span class="stat-icon">📝</span>
                            <span class="stat-value" id="shared-quiz-count">10</span>
                            <span class="stat-label">問</span>
                        </div>
                        <div class="landing-stat">
                            <span class="stat-icon">⏱️</span>
                            <span class="stat-value" id="shared-quiz-time">5</span>
                            <span class="stat-label">分</span>
                        </div>
                    </div>
                    <button id="start-shared-quiz-btn" class="btn-landing-start">クイズを始める</button>
                </div>
            </div>
        </div>

        <!-- 認定書画面 -->
        <div id="certificate-screen" class="screen">
            <div class="certificate-container">
                <div class="certificate-card">
                    <div class="certificate-header">
                        <div class="certificate-badge">🏆</div>
                        <h2 class="certificate-title">認定証</h2>
                    </div>
                    <div class="certificate-body">
                        <div class="certificate-name-section">
                            <p class="certificate-label">この証は、</p>
                            <h3 class="certificate-quiz-title" id="cert-quiz-title">マレーシア文化クイズ</h3>
                            <p class="certificate-label">を修了したことを認定します</p>
                        </div>
                        <div class="certificate-score">
                            <span class="score-label">正解率</span>
                            <span class="score-value" id="cert-score">80%</span>
                            <span class="score-detail" id="cert-detail">(10問中8問正解)</span>
                        </div>
                        <div class="certificate-date">
                            <span id="cert-date">2025年11月15日</span>
                        </div>
                    </div>
                    <div class="certificate-actions">
                        <button id="share-certificate-btn" class="btn-cert-share">
                            📤 結果をシェア
                        </button>
                        <button id="try-again-btn" class="btn-cert-retry">
                            🔄 もう一度挑戦
                        </button>
                        <button id="create-own-quiz-btn" class="btn-cert-create">
                            ✨ 自分でクイズを作る
                        </button>
                    </div>

                    <!-- メール登録カード -->
                    <div class="certificate-email-card">
                        <div class="certificate-email-header">
                            <div class="certificate-email-icon">🎯</div>
                            <h3 class="certificate-email-title">オリジナル問題生成機能</h3>
                        </div>
                        <p class="certificate-email-description">
                            自分だけのクイズを作りたい方へ。早期アクセスと特別価格のご案内をお届けします。
                        </p>
                        <form id="certificate-email-form" class="certificate-email-form">
                            <input
                                type="email"
                                id="certificate-email-input"
                                class="certificate-email-input"
                                placeholder="メールアドレスを入力"
                                required
                            >
                            <button type="submit" class="certificate-email-btn">登録する</button>
                        </form>
                        <p class="certificate-email-note">
                            登録することで、<a href="#" id="certificate-privacy-link" style="color: white; text-decoration: underline;">プライバシーポリシー</a>に同意したものとみなされます。
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- プライバシーポリシーモーダル -->
        <div id="privacy-policy-modal" class="modal hidden">
            <div class="modal-content privacy-modal-content">
                <div class="modal-header">
                    <h2>プライバシーポリシー</h2>
                    <button id="close-privacy-modal" class="btn-close">✕</button>
                </div>
                <div class="privacy-content">
                    <h3>1. 収集する情報</h3>
                    <p>当サービスでは、早期アクセス登録時に以下の情報を収集します：</p>
                    <ul>
                        <li>メールアドレス</li>
                        <li>登録日時</li>
                    </ul>

                    <h3>2. 情報の利用目的</h3>
                    <p>収集した情報は、以下の目的で利用します：</p>
                    <ul>
                        <li>サービスのリリース情報や特別価格のご案内</li>
                        <li>サービスの改善と開発</li>
                    </ul>

                    <h3>3. 情報の第三者提供</h3>
                    <p>お客様の個人情報を、お客様の同意なく第三者に提供することはありません。</p>

                    <h3>4. 情報の管理</h3>
                    <p>お客様の個人情報は、厳重に管理し、不正アクセス、紛失、破壊、改ざん、漏洩などを防止します。</p>

                    <h3>5. お問い合わせ</h3>
                    <p>個人情報の取り扱いに関するお問い合わせは、以下のメールアドレスまでご連絡ください：</p>
                    <p><strong>privacy@quizmaster.com</strong></p>

                    <p class="privacy-date">最終更新日: 2025年11月15日</p>
                </div>
            </div>
        </div>

        <!-- ホーム画面 -->
        <div id="home-screen" class="screen active">
            <div class="container">
                <div class="header-compact">
                    <h1 class="logo-compact">📚 QuizMaster</h1>
                    <div class="streak-badge-compact">
                        <span class="fire-icon">🔥</span>
                        <span id="streak-count">0</span>
                    </div>
                </div>

                <!-- タブナビゲーション -->
                <div class="home-tab-navigation">
                    <button class="home-tab-btn active" data-tab="start">学習開始</button>
                    <button class="home-tab-btn" data-tab="generate">教材生成</button>
                    <button class="home-tab-btn" data-tab="report">レポート</button>
                </div>

                <!-- タブコンテンツ -->
                <div class="home-tab-content active" id="tab-start">
                    <!-- 学習開始セクション -->
                    <div class="quick-start-section-compact">
                        <div class="study-config-compact">
                            <div class="config-row-compact">
                                <label class="config-label-compact">出題範囲</label>
                                <select id="material-select" class="config-select-compact">
                                    <option value="review-priority">復習待ち優先</option>
                                    <option value="all">全ての問題からランダム</option>
                                </select>
                            </div>
                            <div class="config-row-compact">
                                <label class="config-label-compact">出題数</label>
                                <div class="question-count-selector-compact">
                                    <button class="count-btn-compact" data-count="5">5</button>
                                    <button class="count-btn-compact active" data-count="10">10</button>
                                    <button class="count-btn-compact" data-count="15">15</button>
                                    <button class="count-btn-compact" data-count="20">20</button>
                                    <button class="count-btn-compact" data-count="25">25</button>
                                    <button class="count-btn-compact" data-count="30">30</button>
                                </div>
                            </div>
                        </div>
                        <button id="start-quiz-btn" class="btn btn-success btn-large-compact">
                            学習を開始する
                        </button>
                    </div>

                    <!-- 統計（コンパクト） -->
                    <div class="stats-grid-compact">
                        <div class="stat-card-compact">
                            <div class="stat-label-compact">総問題数</div>
                            <div class="stat-value-compact" id="total-questions">0</div>
                        </div>
                        <div class="stat-card-compact">
                            <div class="stat-label-compact">正解率</div>
                            <div class="stat-value-compact" id="accuracy-rate">0%</div>
                        </div>
                        <div class="stat-card-compact clickable" id="review-count-card">
                            <div class="stat-label-compact">復習待ち</div>
                            <div class="stat-value-compact" id="review-count">0</div>
                        </div>
                    </div>
                </div>

                <div class="home-tab-content" id="tab-generate">
                    <button id="manage-references-btn" class="btn btn-secondary btn-large-compact" style="margin-bottom: 20px;">
                        📚 教材ライブラリ
                    </button>

                    <!-- 教材追加セクション -->
                    <div class="upload-section-compact">
                        <!-- PDF/テキスト切り替えタブ -->
                        <div class="input-mode-tabs-compact">
                            <button class="mode-tab-compact active" data-mode="text">📝 テキスト</button>
                            <button class="mode-tab-compact" data-mode="pdf">📄 PDF</button>
                        </div>

                        <!-- テキストモード -->
                        <div id="text-mode" class="input-mode active">
                            <textarea id="text-input" class="text-input-area-compact" placeholder="学習したいテキストを貼り付け..."></textarea>
                            <button id="generate-from-text-btn" class="btn btn-primary btn-large-compact">テキストからクイズを生成</button>
                        </div>

                        <!-- PDFモード -->
                        <div id="pdf-mode" class="input-mode">
                            <div class="upload-box-compact">
                                <input type="file" id="pdf-input" accept=".pdf" hidden>
                                <label for="pdf-input" class="upload-label-compact">
                                    <div class="upload-icon-compact">📄</div>
                                    <div class="upload-text-compact">PDFファイルを選択</div>
                                </label>
                                <div id="file-name" class="file-name-compact"></div>
                            </div>
                            <button id="generate-btn" class="btn btn-primary btn-large-compact" disabled>クイズを生成</button>
                        </div>
                    </div>
                </div>

                <div class="home-tab-content" id="tab-report">
                    <!-- 統計詳細 -->
                    <div class="stats-detail-compact">
                        <div class="stat-detail-card">
                            <div class="stat-detail-label">累計解答数</div>
                            <div class="stat-detail-value" id="total-answered">0</div>
                        </div>
                        <div class="stat-detail-card">
                            <div class="stat-detail-label">累計正解数</div>
                            <div class="stat-detail-value" id="total-correct">0</div>
                        </div>
                    </div>

                    <!-- タグ統計 -->
                    <div class="tag-stats-section-compact">
                        <h3 class="section-title-compact">学習ジャンル</h3>
                        <div id="tag-cloud" class="tag-cloud-compact">
                            <!-- タグクラウドがここに表示されます -->
                        </div>
                    </div>

                    <!-- データリセットセクション -->
                    <div class="data-reset-section">
                        <h3 class="section-title-compact">データ管理</h3>
                        <div class="data-reset-card">
                            <p class="data-reset-description">
                                すべての教材、問題、学習履歴を削除して、アプリを初期状態に戻します。<br>
                                <strong>この操作は取り消せません。</strong>
                            </p>
                            <button id="reset-all-data-btn" class="btn-danger">
                                🗑️ すべてのデータをリセット
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 教材ライブラリ画面 -->
        <div id="references-screen" class="screen">
            <div class="container">
                <div class="header">
                    <button id="back-to-home-btn" class="btn-text">← 戻る</button>
                    <h1 class="logo">📚 教材ライブラリ</h1>
                </div>

                <!-- フィルター・検索バー（コンパクト） -->
                <div class="filter-bar-compact">
                    <input type="text" id="material-search" class="search-input-compact" placeholder="🔍 検索...">
                    <select id="sort-filter" class="filter-select-compact">
                        <option value="date-desc">新しい順</option>
                        <option value="date-asc">古い順</option>
                        <option value="title">タイトル順</option>
                    </select>
                    <div class="view-switcher">
                        <button id="view-list-btn" class="view-btn active" data-view="list">📋 リスト</button>
                        <button id="view-shared-btn" class="view-btn" data-view="shared">📤 共有済み</button>
                    </div>
                </div>

                <div id="references-list" class="materials-grid">
                    <!-- 教材カード一覧がここに表示されます -->
                </div>
            </div>
        </div>

        <!-- 教材詳細画面 -->
        <div id="material-detail-screen" class="screen">
            <div class="container">
                <div class="header">
                    <button id="back-to-library-btn" class="btn-text">← 教材ライブラリへ</button>
                    <h1 class="material-detail-title" id="material-detail-title">教材詳細</h1>
                </div>

                <!-- 教材情報 -->
                <div class="material-info-card">
                    <h2 id="detail-material-title"></h2>
                    <p id="detail-material-summary" class="material-summary"></p>
                    <div id="detail-material-tags" class="material-tags"></div>
                    <div class="material-meta">
                        <span id="detail-upload-date"></span>
                        <span id="detail-question-count"></span>
                    </div>
                </div>

                <!-- アクションボタン -->
                <div class="material-action-buttons" style="margin-bottom: 24px;">
                    <button id="start-material-quiz-btn" class="btn btn-primary btn-large">
                        学習する
                    </button>
                    <button id="share-material-btn" class="btn btn-secondary btn-large">
                        📤 シェア
                    </button>
                </div>

                <!-- タブナビゲーション -->
                <div class="tab-navigation">
                    <button class="tab-btn active" data-tab="overview">📊 概要</button>
                    <button class="tab-btn" data-tab="questions">📝 問題一覧</button>
                    <button class="tab-btn" data-tab="content">📄 本文</button>
                </div>

                <!-- タブコンテンツ -->
                <div class="tab-content active" id="tab-overview">
                    <div class="overview-stats">
                        <div class="stat-box">
                            <div class="stat-box-label">総問題数</div>
                            <div class="stat-box-value" id="overview-total"></div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-box-label">平均正解率</div>
                            <div class="stat-box-value" id="overview-accuracy"></div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-box-label">学習進捗</div>
                            <div class="stat-box-value" id="overview-progress"></div>
                        </div>
                    </div>
                </div>

                <div class="tab-content" id="tab-questions">
                    <div id="questions-list" class="questions-list">
                        <!-- 問題一覧がここに表示されます -->
                    </div>
                </div>

                <div class="tab-content" id="tab-content">
                    <div id="material-content" class="material-content">
                        <!-- 本文がここに表示されます（マークダウン形式） -->
                    </div>
                </div>

                <div class="material-actions">
                    <button id="delete-material-btn" class="btn btn-danger">
                        🗑️ この教材を削除
                    </button>
                </div>
            </div>
        </div>

        <!-- 復習待ち問題一覧画面 -->
        <div id="review-list-screen" class="screen">
            <div class="container">
                <div class="header">
                    <button id="back-to-home-from-review-btn" class="btn-text">← ホームへ</button>
                    <h1 class="logo">📝 復習待ち問題</h1>
                </div>

                <div class="review-list-info">
                    <p><span id="review-list-count">0</span>件の復習待ち問題があります</p>
                </div>

                <div id="review-questions-list" class="review-questions-list">
                    <!-- 復習待ち問題一覧がここに表示されます -->
                </div>
            </div>
        </div>

        <!-- 生成中画面 -->
        <div id="generating-screen" class="screen">
            <div class="container center">
                <div class="spinner"></div>
                <h2>クイズを生成中...</h2>
                <p id="generating-status">PDFを読み込んでいます...</p>
                <div class="progress-bar">
                    <div id="progress-fill" class="progress-fill"></div>
                </div>
            </div>
        </div>

        <!-- クイズ画面 -->
        <div id="quiz-screen" class="screen">
            <div class="container">
                <div class="quiz-header">
                    <button id="quit-btn" class="btn-text">✕ 終了</button>
                    <div class="progress-info">
                        <span id="current-question">1</span> / <span id="total-quiz-questions">10</span>
                    </div>
                </div>

                <div id="quiz-progress-grid" class="progress-grid">
                    <!-- グリッド形式の進捗表示がここに動的に生成されます -->
                </div>

                <div class="difficulty-badge" id="difficulty-badge">基礎</div>

                <!-- タグを問題枠の外に配置 -->
                <div id="question-tags" class="question-tags-outside">
                    <!-- 問題のタグがここに表示されます -->
                </div>

                <div class="question-card">
                    <h2 id="question-text" class="question-text"></h2>
                    <div id="choices-container" class="choices-container"></div>
                </div>

                <!-- ナビゲーション（目立たない） -->
                <div id="quiz-navigation" class="quiz-navigation hidden">
                    <button id="review-explanation-btn" class="nav-link">← 解説を読みなおす</button>
                    <button id="skip-question-btn" class="nav-link">この問題をスキップ →</button>
                </div>

                <!-- フィードバックモーダル -->
                <div id="feedback-modal" class="feedback-modal hidden">
                    <div class="feedback-modal-content">
                        <div class="feedback-modal-header">
                            <span id="feedback-icon"></span>
                            <span id="feedback-title"></span>
                        </div>
                        <div id="feedback-explanation" class="feedback-modal-explanation"></div>
                        <div class="feedback-modal-timer" id="feedback-timer">2</div>
                        <button id="next-question-btn" class="btn-modal">次へ →</button>
                    </div>
                </div>

                <!-- 10秒休憩 -->
                <div id="break-screen" class="break-screen hidden">
                    <div class="break-content">
                        <h2>✨ 深呼吸してリラックス</h2>
                        <p class="break-text">脳が情報を整理しています...</p>
                        <div class="break-timer" id="break-timer">10</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 結果画面 -->
        <div id="result-screen" class="screen">
            <div class="container center">
                <div class="result-icon" id="result-icon">🎉</div>
                <h1 id="result-title">素晴らしい!</h1>
                <p id="result-message"></p>

                <div class="result-stats">
                    <div class="result-stat">
                        <div class="result-stat-label">正解数</div>
                        <div class="result-stat-value">
                            <span id="correct-count">0</span> / <span id="result-total">10</span>
                        </div>
                    </div>
                    <div class="result-stat">
                        <div class="result-stat-label">正解率</div>
                        <div class="result-stat-value" id="result-accuracy">0%</div>
                    </div>
                </div>

                <div class="result-actions">
                    <button id="continue-btn" class="btn btn-primary btn-large">続ける</button>
                    <button id="home-btn" class="btn btn-secondary">ホームへ</button>
                </div>
            </div>
        </div>

        <!-- APIキー入力モーダル -->
        <div id="api-key-modal" class="modal hidden">
            <div class="modal-content">
                <h2>OpenAI APIキー</h2>
                <p>クイズを生成するにはOpenAI APIキーが必要です。</p>
                <a href="https://platform.openai.com/api-keys" target="_blank" class="link">APIキーを取得する</a>
                <input type="password" id="api-key-input" class="input" placeholder="sk-...">
                <div class="modal-actions">
                    <button id="cancel-api-key" class="btn btn-secondary">キャンセル</button>
                    <button id="save-api-key" class="btn btn-primary">保存</button>
                </div>
            </div>
        </div>

        <!-- 共有モーダル -->
        <div id="share-modal" class="modal hidden">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>この教材をシェア</h2>
                    <button id="close-share-modal" class="btn-close">✕</button>
                </div>
                <div class="share-options">
                    <button id="copy-url-btn" class="share-option-btn">
                        <span class="share-icon">🔗</span>
                        <div class="share-option-text">
                            <div class="share-option-title">URLをコピー</div>
                            <div class="share-option-desc">クリップボードにコピーして共有</div>
                        </div>
                    </button>
                    <button id="show-qr-btn" class="share-option-btn">
                        <span class="share-icon">📱</span>
                        <div class="share-option-text">
                            <div class="share-option-title">QRコードを表示</div>
                            <div class="share-option-desc">スマホでスキャンして共有</div>
                        </div>
                    </button>
                </div>
                <div id="share-result" class="share-result hidden">
                    <div id="share-success" class="share-message hidden">
                        <span class="success-icon">✓</span>
                        <span>URLをコピーしました！</span>
                    </div>
                    <div id="qr-code-container" class="qr-container hidden">
                        <div id="qr-code"></div>
                        <p class="qr-hint">QRコードをスキャンしてください</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // PDF.jsのworkerを設定
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
    <script src="app.js"></script>
</body>
</html>
