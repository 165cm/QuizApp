<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>科学的勉強法クイズアプリ</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Noto+Sans+JP:wght@400;500;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.5.0/lz-string.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/davidshimjs-qrcodejs@0.0.2/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.49.4/dist/umd/supabase.min.js"></script>
</head>

<body>
    <!-- Global Loader -->
    <div id="global-loader" class="global-loader">
        <div class="loader-content">
            <div class="loader-spinner"></div>
            <p>Loading QuizMaster...</p>
        </div>
    </div>
    <!-- グローバルナビゲーション -->
    <nav id="global-nav" class="global-nav">
        <a href="#" class="nav-item active" data-screen="home" data-tab="start">
            <span class="nav-icon">🏠</span>
            <span class="nav-label">ホーム</span>
        </a>
        <a href="#" class="nav-item" data-screen="references">
            <span class="nav-icon">📚</span>
            <span class="nav-label">ライブラリ</span>
        </a>
        <a href="#" class="nav-item" data-screen="home" data-tab="generate">
            <span class="nav-icon">➕</span>
            <span class="nav-label">生成</span>
        </a>
        <a href="#" class="nav-item" data-screen="home" data-tab="report">
            <span class="nav-icon">📊</span>
            <span class="nav-label">レポート</span>
        </a>
        <a href="#" class="nav-item" data-screen="settings">
            <span class="nav-icon">⚙️</span>
            <span class="nav-label">設定</span>
        </a>
    </nav>

    <div id="app" class="app-with-nav">
        <!-- シェア専用LP画面 -->
        <div id="shared-quiz-landing" class="screen">
            <div class="landing-container">
                <div class="landing-hero">
                    <div class="landing-icon">🎓</div>
                    <h1 class="landing-title" id="shared-quiz-title">クイズに挑戦</h1>
                    <p class="landing-description" id="shared-quiz-description">
                        友達から共有されたクイズです。<br>
                        あなたの知識を試してみましょう！
                    </p>
                    <div class="landing-stats">
                        <div class="landing-stat">
                            <span class="stat-icon">📝</span>
                            <span class="stat-value" id="shared-quiz-count">10</span>
                            <span class="stat-label">問</span>
                        </div>
                        <div class="landing-stat">
                            <span class="stat-icon">⏱️</span>
                            <span class="stat-value" id="shared-quiz-time">5</span>
                            <span class="stat-label">分</span>
                        </div>
                        <div class="landing-stat" id="view-count-stat" style="display: none;">
                            <span class="stat-icon">👁️</span>
                            <span class="stat-value" id="shared-quiz-views">0</span>
                            <span class="stat-label">人が挑戦</span>
                        </div>
                    </div>
                    <button id="start-shared-quiz-btn" class="btn-landing-start">クイズを始める</button>
                </div>
            </div>
        </div>

        <!-- 認定書画面 -->
        <div id="certificate-screen" class="screen">
            <div class="certificate-container">
                <div class="certificate-card">
                    <div class="certificate-header">
                        <!-- <div class="certificate-badge">🏆</div> -->
                        <img id="cert-rank-image" class="certificate-rank-image" src="" alt="Rank Badge"
                            style="display: none;">
                        <h2 class="certificate-title">認定証</h2>
                    </div>
                    <div class="certificate-body">
                        <div class="certificate-name-section">
                            <p class="certificate-label">この証は、</p>
                            <h3 class="certificate-quiz-title" id="cert-quiz-title">マレーシア文化クイズ</h3>
                            <p class="certificate-label">を修了したことを認定します</p>
                        </div>
                        <div class="certificate-score">
                            <span class="score-label">正解率</span>
                            <span class="score-value" id="cert-score">80%</span>
                            <span class="score-detail" id="cert-detail">(10問中8問正解)</span>
                        </div>
                        <div class="certificate-date">
                            <span id="cert-date">2025年11月15日</span>
                        </div>
                    </div>
                    <div class="certificate-actions">
                        <button id="share-certificate-btn" class="btn-cert-share">
                            📤 結果をシェア
                        </button>
                        <button id="try-again-btn" class="btn-cert-retry">
                            🔄 もう一度挑戦
                        </button>
                        <button id="create-own-quiz-btn" class="btn-cert-create">
                            ✨ 自分でクイズを作る
                        </button>
                    </div>


                </div>
            </div>
        </div>

        <!-- 利用規約モーダル -->
        <div id="terms-modal" class="modal hidden">
            <div class="modal-content privacy-modal-content">
                <div class="modal-header">
                    <h2>利用規約</h2>
                    <button id="close-terms-modal" class="btn-close">✕</button>
                </div>
                <div class="privacy-content">
                    <p class="privacy-date">最終更新日: 2025年12月15日</p>

                    <h3>第1条（適用）</h3>
                    <p>本規約は、QuizMaster（以下「本サービス」）の利用に関する条件を定めるものです。ユーザーは本サービスを利用することにより、本規約に同意したものとみなされます。</p>

                    <h3>第2条（サービスの内容）</h3>
                    <p>本サービスは、AIを活用してユーザーがアップロードしたコンテンツからクイズを自動生成する学習支援サービスです。</p>

                    <h3>第3条（禁止事項）</h3>
                    <p>ユーザーは以下の行為を行ってはなりません：</p>
                    <ul>
                        <li>第三者の著作権、知的財産権を侵害するコンテンツのアップロード</li>
                        <li>許可なく第三者の著作物（書籍、論文、記事等）を利用する行為</li>
                        <li>著作権侵害コンテンツを公開・共有する行為</li>
                        <li>法令または公序良俗に違反する行為</li>
                        <li>本サービスの運営を妨害する行為</li>
                    </ul>

                    <h3>第4条（AI生成コンテンツについて）</h3>
                    <p>本サービスで生成されるクイズおよび画像はAIによる自動生成です。</p>
                    <ul>
                        <li>生成されたコンテンツの正確性、完全性は保証されません</li>
                        <li>既存の著作物との類似性についてはユーザー自身でご確認ください</li>
                        <li>AI生成コンテンツの利用はユーザー自身の責任において行ってください</li>
                        <li>生成されたコンテンツが第三者の権利を侵害していないことを確認する義務はユーザーにあります</li>
                    </ul>

                    <h3>第5条（知的財産権）</h3>
                    <ul>
                        <li>本サービス自体の著作権その他の知的財産権は運営者に帰属します</li>
                        <li>ユーザーがアップロードしたコンテンツの著作権はユーザーまたは原権利者に帰属します</li>
                        <li>ユーザーは、本サービスの利用に必要な範囲で、アップロードしたコンテンツを運営者が利用することを許諾します</li>
                    </ul>

                    <h3>第6条（免責事項）</h3>
                    <ul>
                        <li>本サービスは「現状有姿」で提供され、特定目的への適合性を保証しません</li>
                        <li>本サービスの利用により生じた損害について、運営者は故意または重過失がある場合を除き責任を負いません</li>
                        <li>ユーザー間またはユーザーと第三者間のトラブルについて、運営者は責任を負いません</li>
                    </ul>

                    <h3>第7条（著作権侵害への対応）</h3>
                    <p>著作権侵害コンテンツを発見した場合、運営者は予告なく当該コンテンツを削除できるものとします。繰り返し侵害を行うユーザーのアカウントは停止または削除される場合があります。</p>

                    <h3>第8条（サービスの変更・停止）</h3>
                    <p>運営者は、事前の通知なく本サービスの内容を変更、または提供を停止できるものとします。</p>

                    <h3>第9条（規約の変更）</h3>
                    <p>運営者は、必要に応じて本規約を変更できるものとします。変更後の規約は本サービス上に掲載した時点で効力を生じます。</p>

                    <h3>第10条（準拠法・管轄）</h3>
                    <p>本規約は日本法に準拠し、本サービスに関する紛争は東京地方裁判所を第一審の専属的合意管轄裁判所とします。</p>
                </div>
            </div>
        </div>

        <!-- プライバシーポリシーモーダル -->
        <div id="privacy-policy-modal" class="modal hidden">
            <div class="modal-content privacy-modal-content">
                <div class="modal-header">
                    <h2>プライバシーポリシー</h2>
                    <button id="close-privacy-modal" class="btn-close">✕</button>
                </div>
                <div class="privacy-content">
                    <p class="privacy-date">最終更新日: 2025年12月15日</p>

                    <h3>1. 収集する情報</h3>
                    <p>当サービスでは、以下の情報を収集します：</p>
                    <ul>
                        <li><strong>アカウント情報</strong>：Googleログイン時のメールアドレス、表示名、プロフィール画像</li>
                        <li><strong>学習データ</strong>：作成した教材、クイズの回答履歴、学習統計</li>
                        <li><strong>アップロードコンテンツ</strong>：PDF、テキスト、URL等の入力データ</li>
                        <li><strong>端末情報</strong>：デバイスID（無料枠管理用）</li>
                    </ul>

                    <h3>2. 情報の利用目的</h3>
                    <p>収集した情報は、以下の目的で利用します：</p>
                    <ul>
                        <li>クイズ生成および学習機能の提供</li>
                        <li>クラウド同期によるデータバックアップ</li>
                        <li>学習統計の算出・表示</li>
                        <li>サービスの改善と開発</li>
                    </ul>

                    <h3>3. 第三者サービスへのデータ送信</h3>
                    <p>本サービスは以下の第三者サービスを利用しており、必要な範囲でデータを送信します：</p>
                    <ul>
                        <li><strong>OpenAI API</strong>：クイズ生成のためのテキスト処理</li>
                        <li><strong>Google Gemini API</strong>：画像生成</li>
                        <li><strong>Supabase</strong>：認証、データベース、ストレージ</li>
                    </ul>
                    <p>これらのサービスは各社のプライバシーポリシーに従ってデータを処理します。</p>

                    <h3>4. データの保管</h3>
                    <ul>
                        <li><strong>ローカルストレージ</strong>：学習データはお使いのブラウザに保存されます</li>
                        <li><strong>クラウド（Supabase）</strong>：ログイン時にデータが同期・バックアップされます</li>
                        <li><strong>生成画像</strong>：ストレージ容量節約のため30日後に自動削除されます</li>
                    </ul>

                    <h3>5. ユーザーの権利</h3>
                    <p>ユーザーは以下の権利を有します：</p>
                    <ul>
                        <li>設定画面からの学習データの削除</li>
                        <li>アカウントの削除依頼</li>
                        <li>保存データへのアクセス</li>
                    </ul>

                    <h3>6. Cookie・ローカルストレージ</h3>
                    <p>本サービスはログイン状態の維持および学習データの保存のためにローカルストレージを使用します。</p>

                    <h3>7. お問い合わせ</h3>
                    <p>個人情報の取り扱いに関するお問い合わせは、GitHubリポジトリのIssueまたは以下のメールアドレスまでご連絡ください。</p>
                </div>
            </div>
        </div>

        <!-- ホーム画面 -->
        <div id="home-screen" class="screen active">
            <div class="container">
                <div class="header-compact">
                    <h1 class="logo-compact">📚 QuizMaster</h1>
                    <div class="header-right">
                        <!-- Login Button (shown when logged out) -->
                        <button id="login-btn" class="btn-google-login">
                            <svg width="18" height="18" viewBox="0 0 24 24">
                                <path fill="#4285F4"
                                    d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" />
                                <path fill="#34A853"
                                    d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" />
                                <path fill="#FBBC05"
                                    d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" />
                                <path fill="#EA4335"
                                    d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" />
                            </svg>
                            ログイン
                        </button>

                        <!-- User Info (shown when logged in) -->
                        <div id="user-info" class="user-info" style="display: none;">
                            <img id="user-avatar" class="user-avatar" src="" alt="">
                            <span id="user-name" class="user-name"></span>
                            <button id="logout-btn" class="btn-logout">ログアウト</button>
                        </div>
                    </div>
                </div>

                <!-- タブナビゲーション -->
                <!-- タブコンテンツ -->
                <div class="home-tab-content active" id="tab-start">
                    <!-- 学習開始セクション -->
                    <div class="quick-start-section-compact">
                        <div class="study-config-compact">
                            <div class="config-row-compact">
                                <label class="config-label-compact">出題範囲</label>
                                <select id="material-select" class="config-select-compact">
                                    <option value="review-priority">復習待ち優先</option>
                                    <option value="all">全ての問題からランダム</option>
                                </select>
                            </div>
                            <div class="config-row-compact">
                                <label class="config-label-compact">出題数</label>
                                <div class="question-count-selector-compact">
                                    <button class="count-btn-compact" data-count="5">5</button>
                                    <button class="count-btn-compact active" data-count="10">10</button>
                                    <button class="count-btn-compact" data-count="15">15</button>
                                    <button class="count-btn-compact" data-count="20">20</button>
                                    <button class="count-btn-compact" data-count="25">25</button>
                                    <button class="count-btn-compact" data-count="30">30</button>
                                </div>
                            </div>
                        </div>
                        <button id="start-quiz-btn" class="btn btn-success btn-large-compact">
                            学習を開始する
                        </button>
                    </div>

                    <!-- Public Gallery Banner -->
                    <div class="public-gallery-banner" style="margin-bottom: 1.5rem;">
                        <button id="go-to-public-btn" class="btn btn-public-gallery">
                            <span class="gallery-icon">🌏</span>
                            <div class="gallery-text">
                                <span class="gallery-title">みんなのクイズ広場へ</span>
                                <span class="gallery-desc">人気の無料クイズを探しに行こう！</span>
                            </div>
                            <span class="gallery-arrow">→</span>
                        </button>
                    </div>

                    <!-- 統計（コンパクト） -->
                    <div class="stats-grid-compact">
                        <div class="stat-card-compact">
                            <div class="stat-label-compact">総問題数</div>
                            <div class="stat-value-compact" id="total-questions">0</div>
                        </div>
                        <div class="stat-card-compact">
                            <div class="stat-label-compact">正解率</div>
                            <div class="stat-value-compact" id="accuracy-rate">0%</div>
                        </div>
                        <div class="stat-card-compact clickable" id="review-count-card">
                            <div class="stat-label-compact">復習待ち</div>
                            <div class="stat-value-compact" id="review-count">0</div>
                        </div>
                        <div class="stat-card-compact">
                            <div class="stat-label-compact">連続学習</div>
                            <div class="stat-value-compact" id="streak-count">0</div>
                        </div>
                    </div>
                </div>

                <div class="home-tab-content" id="tab-generate">
                    <!-- 教材追加セクション -->
                    <div class="upload-section-compact">
                        <!-- PDF/テキスト/URL切り替えタブ -->
                        <div class="input-mode-tabs-compact">
                            <button class="mode-tab-compact active" data-mode="text">📝 テキスト</button>
                            <button class="mode-tab-compact" data-mode="pdf">📄 PDF</button>
                            <button class="mode-tab-compact" data-mode="url">🌐 URL</button>
                        </div>

                        <!-- 画像生成オプション -->
                        <div class="image-gen-option">
                            <label class="image-gen-toggle">
                                <input type="checkbox" id="image-gen-checkbox">
                                <span class="toggle-slider"></span>
                                <span class="toggle-label">🎨 画像付きクイズ</span>
                            </label>
                            <p class="image-gen-hint">各問題に記憶定着をサポートするユニークな画像を生成します（コスト削減モードON）</p>
                        </div>

                        <!-- テキストモード -->
                        <div id="text-mode" class="input-mode active">
                            <textarea id="text-input" class="text-input-area-compact"
                                placeholder="学習したいテキストを貼り付け..."></textarea>
                            <button id="generate-from-text-btn"
                                class="btn btn-primary btn-large-compact">テキストからクイズを生成</button>
                        </div>

                        <!-- PDFモード -->
                        <div id="pdf-mode" class="input-mode">
                            <div class="upload-box-compact">
                                <input type="file" id="pdf-input" accept=".pdf" hidden>
                                <label for="pdf-input" class="upload-label-compact">
                                    <div class="upload-icon-compact">📄</div>
                                    <div class="upload-text-compact">PDFファイルを選択</div>
                                </label>
                                <div id="file-name" class="file-name-compact"></div>
                            </div>
                            <button id="generate-btn" class="btn btn-primary btn-large-compact" disabled>クイズを生成</button>
                        </div>

                        <!-- URLモード -->
                        <div id="url-mode" class="input-mode">
                            <input type="url" id="url-input" class="url-input-compact"
                                placeholder="https://example.com/article">
                            <p class="url-hint">WebページのURLを入力してください。記事やブログなどのテキストコンテンツからクイズを生成します。</p>
                            <button id="generate-from-url-btn"
                                class="btn btn-primary btn-large-compact">URLからクイズを生成</button>
                        </div>
                    </div>
                </div>

                <div class="home-tab-content" id="tab-report">
                    <!-- 統計詳細 -->
                    <div class="stats-detail-compact">
                        <div class="stat-detail-card">
                            <div class="stat-detail-label">累計解答数</div>
                            <div class="stat-detail-value" id="total-answered">0</div>
                        </div>
                        <div class="stat-detail-card">
                            <div class="stat-detail-label">累計正解数</div>
                            <div class="stat-detail-value" id="total-correct">0</div>
                        </div>
                    </div>

                    <!-- 興味チャート -->
                    <div class="report-section">
                        <h3 class="section-title-compact">学習の興味 (Top ジャンル)</h3>
                        <div id="interests-chart-container" class="chart-container">
                            <!-- 棒グラフがここに表示されます -->
                        </div>
                    </div>

                    <!-- 苦手分野アラート -->
                    <div class="report-section">
                        <h3 class="section-title-compact">苦手ポイント (要復習)</h3>
                        <div id="weak-points-container" class="weak-points-grid">
                            <!-- 苦手カードがここに表示されます -->
                        </div>
                    </div>

                    <!-- データリセットセクションは設定画面に移動しました -->
                </div>
            </div>
        </div>

        <!-- 教材ライブラリ画面 -->
        <div id="references-screen" class="screen">
            <div class="container">
                <div class="header">
                    <button id="back-to-home-btn" class="btn-text">← 戻る</button>
                    <h1 class="logo">📚 教材ライブラリ</h1>
                </div>

                <!-- フィルター・検索バー（コンパクト） -->
                <div class="filter-bar-compact">
                    <input type="text" id="material-search" class="search-input-compact" placeholder="🔍 検索...">
                    <select id="sort-filter" class="filter-select-compact">
                        <option value="date-desc">新しい順</option>
                        <option value="date-asc">古い順</option>
                        <option value="title">タイトル順</option>
                    </select>
                    <div class="view-switcher">
                        <button id="view-list-btn" class="view-btn active" data-view="list">📋 リスト</button>
                        <button id="view-shared-btn" class="view-btn" data-view="shared">📤 共有済み</button>
                        <button id="toggle-selection-btn" class="view-btn">✅ 選択</button>
                    </div>
                </div>

                <!-- Action Bar for Selected Items -->
                <div id="selection-action-bar" class="selection-action-bar hidden">
                    <span id="selected-count-label">0件選択中</span>
                    <div class="selection-buttons">
                        <button id="select-all-btn" class="btn-compact">全選択</button>
                        <button id="delete-selected-btn" class="btn-danger-compact">🗑️ 削除</button>
                    </div>
                </div>

                <div id="references-list" class="materials-grid">
                    <!-- 教材カード一覧がここに表示されます -->
                </div>
            </div>
        </div>

        <!-- みんなのクイズ広場 (Public Gallery) -->
        <div id="public-library-screen" class="screen">
            <div class="container">
                <div class="header">
                    <button id="back-to-home-from-public-btn" class="btn-text">← ホームへ</button>
                    <h1 class="logo">🌏 みんなのクイズ広場</h1>
                </div>

                <!-- SEO Section -->
                <div class="seo-section">
                    <h2 class="seo-title">AIが生成した無料の学習クイズ集</h2>
                    <p class="seo-description">
                        ユーザーが作成したオリジナルのクイズに挑戦しよう！<br>
                        資格試験、語学学習、雑学、エンタメなど、様々なジャンルの問題が無料で解き放題。<br>
                        <span class="seo-keywords">#AIクイズ #無料問題集 #資格勉強 #英語学習 #過去問</span>
                    </p>
                </div>

                <!-- フィルター -->
                <div class="filter-bar-compact">
                    <input type="text" id="public-search" class="search-input-compact" placeholder="🔍 公開クイズを検索...">
                    <div class="view-switcher">
                        <span class="refresh-hint" id="public-refresh-btn" style="cursor:pointer;">🔄 更新</span>
                    </div>
                </div>

                <div id="public-list" class="materials-grid">
                    <!-- 公開クイズがここにロードされます -->
                    <div class="loader-spinner"></div>
                </div>
            </div>
        </div>

        <!-- 教材詳細画面 -->
        <div id="material-detail-screen" class="screen">
            <div class="container">
                <div class="header">
                    <button id="back-to-library-btn" class="btn-text">← 教材ライブラリへ</button>
                    <h1 class="material-detail-title" id="material-detail-title">教材詳細</h1>
                </div>

                <!-- 教材情報 -->
                <div class="material-info-card">
                    <h2 id="detail-material-title"></h2>
                    <p id="detail-material-summary" class="material-summary"></p>
                    <div id="detail-material-tags" class="material-tags"></div>
                    <div class="material-meta">
                        <span id="detail-upload-date"></span>
                        <span id="detail-question-count"></span>
                    </div>
                    <div id="detail-expiration-info" class="expiration-info"></div>
                </div>

                <!-- アクションボタン -->
                <div class="material-action-buttons" style="margin-bottom: 24px;">
                    <button id="start-material-quiz-btn" class="btn btn-primary btn-large">
                        学習する
                    </button>
                    <button id="share-material-btn" class="btn btn-secondary btn-large">
                        📤 シェア
                    </button>
                </div>

                <!-- タブナビゲーション -->
                <div class="tab-navigation">
                    <button class="tab-btn active" data-tab="overview">📊 概要</button>
                    <button class="tab-btn" data-tab="questions">📝 問題一覧</button>
                    <button class="tab-btn" data-tab="content">📄 元原稿</button>
                </div>

                <!-- タブコンテンツ -->
                <div class="tab-content active" id="tab-overview">
                    <div class="overview-stats">
                        <div class="stat-box">
                            <div class="stat-box-label">総問題数</div>
                            <div class="stat-box-value" id="overview-total"></div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-box-label">平均正解率</div>
                            <div class="stat-box-value" id="overview-accuracy"></div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-box-label">学習進捗</div>
                            <div class="stat-box-value" id="overview-progress"></div>
                        </div>
                    </div>
                </div>

                <div class="tab-content" id="tab-questions">
                    <div id="questions-list" class="questions-list">
                        <!-- 問題一覧がここに表示されます -->
                    </div>
                </div>

                <div class="tab-content" id="tab-content">
                    <div id="material-content" class="material-content">
                        <!-- 本文がここに表示されます（マークダウン形式） -->
                    </div>
                </div>

                <div class="material-actions">
                    <button id="delete-material-btn" class="btn btn-danger">
                        🗑️ この教材を削除
                    </button>
                </div>
            </div>
        </div>

        <!-- 復習待ち問題一覧画面 -->
        <div id="review-list-screen" class="screen">
            <div class="container">
                <div class="header">
                    <button id="back-to-home-from-review-btn" class="btn-text">← ホームへ</button>
                    <h1 class="logo">📝 復習待ち問題</h1>
                </div>

                <div class="review-list-info">
                    <p><span id="review-list-count">0</span>件の復習待ち問題があります</p>
                </div>

                <div id="review-questions-list" class="review-questions-list">
                    <!-- 復習待ち問題一覧がここに表示されます -->
                </div>
            </div>
        </div>

        <!-- 生成中画面 -->
        <!-- 生成中画面 -->
        <div id="generating-screen" class="screen hidden">
            <div class="container center">
                <div class="spinner"></div>
                <h2>クイズを生成中...</h2>
                <p id="generating-status">PDFを読み込んでいます...</p>
                <div class="progress-bar">
                    <div id="progress-fill" class="progress-fill"></div>
                </div>

                <!-- Mini Review Section -->
                <div id="mini-review-container" class="mini-review-container hidden">
                    <p class="mini-review-label">待っている間に復習しよう！</p>
                    <div id="mini-review-card" class="mini-review-card">
                        <!-- Dynamic Question Content -->
                    </div>
                </div>
            </div>
        </div>

        <!-- クイズ画面 -->
        <div id="quiz-screen" class="screen">
            <div class="container">
                <div class="quiz-header">
                    <button id="quit-btn" class="btn-secondary btn-icon">
                        <span style="font-size: 1.2rem;">✕</span>
                    </button>
                    <div class="progress-bar-container">
                        <div class="progress-info-text">
                            <span class="progress-label">Question</span>
                            <span class="progress-numbers">
                                <span id="current-question">1</span>
                                <span class="progress-divider">/</span>
                                <span id="total-quiz-questions">10</span>
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            <div id="quiz-progress-grid" class="progress-grid">
                <!-- グリッド形式の進捗表示がここに動的に生成されます -->
            </div>

            <div class="difficulty-badge" id="difficulty-badge">基礎</div>

            <!-- タグを問題枠の外に配置 -->
            <div id="question-tags" class="question-tags-outside">
                <!-- 問題のタグがここに表示されます -->
            </div>

            <div class="question-card">
                <div id="question-image-container" class="quiz-image-container" style="display: none;">
                    <img id="question-image" class="quiz-image" alt="Quiz illustration">
                </div>
                <h2 id="question-text" class="question-text"></h2>
                <div id="choices-container" class="choices-container"></div>
            </div>

            <!-- ナビゲーション（目立たない） -->
            <div id="quiz-navigation" class="quiz-navigation hidden">
                <button id="review-explanation-btn" class="nav-link">← 解説を読みなおす</button>
                <button id="skip-question-btn" class="nav-link">この問題をスキップ →</button>
            </div>

            <!-- フィードバックモーダル -->
            <div id="feedback-modal" class="feedback-modal hidden">
                <div class="feedback-modal-content">
                    <div class="feedback-modal-header">
                        <span id="feedback-icon"></span>
                        <span id="feedback-title"></span>
                    </div>
                    <div id="feedback-explanation" class="feedback-modal-explanation"></div>

                    <div id="feedback-explanation" class="feedback-modal-explanation"></div>

                    <div class="feedback-actions">
                        <!-- Auto-advance toggle -->
                        <div class="auto-advance-toggle" id="auto-advance-toggle-container">
                            <label class="toggle-switch">
                                <input type="checkbox" id="auto-advance-checkbox">
                                <span class="toggle-slider-small"></span>
                            </label>
                            <span class="toggle-text">自動進行</span>
                        </div>

                        <div class="feedback-next-area">
                            <div class="feedback-modal-timer" id="feedback-timer"></div>
                            <button id="next-question-btn" class="btn-modal btn-next-compact">次へ →</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 10秒休憩 -->
            <div id="break-screen" class="break-screen hidden">
                <div class="break-content">
                    <h2>✨ 深呼吸してリラックス</h2>
                    <p class="break-text">脳が情報を整理しています...</p>
                    <div class="break-timer" id="break-timer">10</div>
                </div>
            </div>
        </div>
    </div>

    <!-- 結果画面 -->
    <div id="result-screen" class="screen">
        <div class="container center">
            <div class="result-icon" id="result-icon">🎉</div>
            <h1 id="result-title">素晴らしい!</h1>
            <p id="result-message"></p>

            <div class="result-stats">
                <div class="result-stat">
                    <div class="result-stat-label">正解数</div>
                    <div class="result-stat-value">
                        <span id="correct-count">0</span> / <span id="result-total">10</span>
                    </div>
                </div>
                <div class="result-stat">
                    <div class="result-stat-label">正解率</div>
                    <div class="result-stat-value" id="result-accuracy">0%</div>
                </div>
            </div>

            <div class="result-actions">
                <button id="continue-btn" class="btn btn-primary btn-large">続ける</button>
                <button id="home-btn" class="btn btn-secondary">ホームへ</button>
            </div>
        </div>
    </div>


    <!-- 認定証画面 (Certificate Screen) -->
    <div id="certificate-screen" class="screen">
        <div class="result-certificate-container" style="max-width: 500px; margin: 0 auto; padding: 20px;">
            <div class="certificate-card" id="certificate-card">
                <div class="certificate-header"
                    style="background: linear-gradient(135deg, #1e293b, #0f172a); padding: 20px; border-radius: 20px 20px 0 0; text-align: center; color: white;">
                    <div style="font-size: 0.9rem; opacity: 0.8; margin-bottom: 5px;">QUIZ MASTER CERTIFICATE</div>
                    <h2 id="cert-quiz-title" style="margin: 0; font-size: 1.5rem;">クイズタイトル</h2>
                </div>

                <div class="certificate-body"
                    style="background: #1e293b; padding: 30px 20px; text-align: center; color: white;">
                    <!-- Rank Showcase inserted here via JS -->

                    <div class="certificate-name-section" style="margin-top: 20px;">
                        <div style="font-size: 0.9rem; opacity: 0.7;">SCORE</div>
                        <div id="cert-score"
                            style="font-size: 3.5rem; font-weight: 800; background: linear-gradient(to right, #fbbf24, #d97706); -webkit-background-clip: text; color: transparent;">
                            100%</div>
                        <div id="cert-detail" style="font-size: 1rem; opacity: 0.8; margin-bottom: 20px;">(10問中10問正解)
                        </div>

                        <div style="border-top: 1px solid rgba(255,255,255,0.1); width: 60%; margin: 20px auto;"></div>

                        <div style="font-size: 0.9rem; opacity: 0.7;">DATE</div>
                        <div id="cert-date" style="font-size: 1.1rem; font-family: monospace;">2024.12.15</div>
                    </div>
                </div>

                <div class="certificate-footer"
                    style="background: #0f172a; padding: 20px; border-radius: 0 0 20px 20px; text-align: center;">
                    <div style="font-size: 0.8rem; color: #64748b;">Powered by QuizMaster</div>
                </div>
            </div>

            <!-- Actions -->
            <div class="certificate-actions"
                style="margin-top: 2rem; display: flex; flex-direction: column; gap: 1rem;">
                <!-- Share to X -->
                <button id="share-x-cert-btn" class="btn-share-x-large"
                    style="background: black; color: white; border: none; padding: 1rem; border-radius: 12px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; width: 100%;">
                    <span style="font-size: 1.2rem;">𝕏</span> 結果をポストする
                </button>

                <!-- Share Modal Open -->
                <button id="share-certificate-btn" class="btn btn-secondary" style="width: 100%;">
                    📤 その他の方法でシェア
                </button>

                <!-- Create Own Quiz -->
                <button id="create-own-quiz-btn" class="btn-primary"
                    style="background: linear-gradient(135deg, #f59e0b, #d97706); border: none; padding: 1rem; border-radius: 12px; font-weight: bold; cursor: pointer; color: white; width: 100%;">
                    自分もクイズを作る！
                </button>

                <!-- Back -->
                <button id="try-again-btn" class="btn-secondary"
                    style="background: transparent; border: 1px solid rgba(255,255,255,0.2); padding: 0.8rem; border-radius: 12px; color: white; width: 100%; cursor: pointer;">
                    ホームに戻る
                </button>
            </div>
        </div>
    </div>

    <!-- 設定画面 (Unified Settings) -->
    <div id="settings-screen" class="screen">
        <div class="container">
            <div class="header-compact">
                <h1 class="logo-compact">⚙️ 設定</h1>
            </div>

            <div class="settings-tabs">
                <button class="settings-tab-btn active" data-tab="general">一般 / API</button>
                <button class="settings-tab-btn" data-tab="prompts">プロンプト編集</button>
                <button class="settings-tab-btn" data-tab="data">データ管理</button>
            </div>

            <!-- General Tab (API Key) -->
            <div id="settings-tab-general" class="settings-tab-content active">
                <div class="setting-group">
                    <label class="setting-label">OpenAI APIキー</label>
                    <p class="setting-desc">クイズ生成に使用するAPIキーを設定します。</p>
                    <div class="api-key-input-container">
                        <input type="password" id="settings-api-key-input" class="input" placeholder="sk-...">
                        <button id="toggle-api-key-visibility" class="btn-icon">👁️</button>
                    </div>
                </div>

                <!-- Google API Key -->
                <div class="setting-group">
                    <label class="setting-label">Google APIキー (Nano Banana Pro)</label>
                    <p class="setting-desc">Nano Banana Pro (Imagen 3) 用のAPIキー。</p>
                    <div class="api-key-input-container">
                        <input type="password" id="settings-google-api-key-input" class="input" placeholder="AI...">
                        <button id="toggle-google-api-key-visibility" class="btn-icon">👁️</button>
                    </div>
                </div>

                <!-- Image Model Selection -->
                <div class="setting-group">
                    <label class="setting-label">画像生成モデル</label>
                    <div class="static-value">Google Nano Banana Pro (推奨)</div>
                    <!-- DALL-E 3 removed as per request -->
                </div>

                <div class="setting-actions">
                    <button id="save-general-settings-btn" class="btn btn-primary btn-full-width">設定を保存</button>
                </div>
                <p class="api-key-status" id="api-key-status-msg"></p>
            </div>
        </div>

        <!-- Prompts Tab (Customization) -->
        <div id="settings-tab-prompts" class="settings-tab-content">
            <div class="alert-box info">
                <p>クイズ生成の挙動をカスタマイズできます。<br>
                    プロンプトのフォーマットは自動で最適化され、以下の設定が反映されます。</p>
            </div>

            <div class="setting-group">
                <label class="setting-label">対象レベル・読者</label>
                <p class="setting-desc">誰に向けたクイズにするかを指定します</p>
                <input type="text" id="setting-target-level" class="input" placeholder="例: 中学生、TOEIC 600点、ビジネス初級、5歳児"
                    style="width: 100%;">
            </div>

            <div class="setting-group">
                <label class="setting-label">追加の指示（こだわり）</label>
                <p class="setting-desc">雰囲気や文体、特に重視することなどを自由に指示できます</p>
                <textarea id="setting-custom-instructions" class="prompt-textarea" placeholder="例: 関西弁で、スパルタに、ユーモアを交えて"
                    style="min-height: 100px;"></textarea>
            </div>

            <div class="setting-actions-footer">
                <button id="reset-prompts-btn" class="btn btn-secondary">リセット</button>
                <button id="save-prompts-btn" class="btn btn-primary">設定を保存</button>
            </div>
        </div>

        <!-- Data Management Tab -->
        <div id="settings-tab-data" class="settings-tab-content">
            <div class="settings-section">
                <h3>データ管理</h3>
                <p class="settings-description">目的に応じてデータを削除・リセットできます。</p>

                <div class="data-management-grid">
                    <!-- Stats Reset -->
                    <div class="setting-card">
                        <div class="setting-card-icon">📊</div>
                        <div class="setting-card-content">
                            <div class="setting-card-title">学習記録をリセット</div>
                            <div class="setting-card-desc">正解率や連続学習記録をリセットして、最初からやり直します。</div>
                        </div>
                        <button id="btn-reset-stats" class="btn btn-secondary btn-sm">リセット</button>
                    </div>

                    <!-- Materials Reset -->
                    <div class="setting-card">
                        <div class="setting-card-icon">📚</div>
                        <div class="setting-card-content">
                            <div class="setting-card-title">教材をすべて削除</div>
                            <div class="setting-card-desc">保存した教材や問題をすべて削除して、ライブラリを空にします。</div>
                        </div>
                        <button id="btn-reset-materials" class="btn btn-danger btn-sm">削除</button>
                    </div>

                    <!-- Factory Reset -->
                    <div class="setting-card danger-zone">
                        <div class="setting-card-icon">⚠️</div>
                        <div class="setting-card-content">
                            <div class="setting-card-title">アプリを完全初期化</div>
                            <div class="setting-card-desc">すべてのデータを消去して、アプリをインストール直後の状態に戻します。</div>
                        </div>
                        <button id="btn-reset-all" class="btn btn-danger">初期化</button>
                    </div>
                </div>
            </div>

            <!-- Legal Links Section -->
            <div class="settings-section legal-section">
                <h3>利用規約・プライバシー</h3>
                <div class="legal-links">
                    <button id="open-terms-btn" class="legal-link-btn">
                        <span class="legal-icon">📜</span>
                        <span>利用規約</span>
                        <span class="legal-arrow">→</span>
                    </button>
                    <button id="open-privacy-btn" class="legal-link-btn">
                        <span class="legal-icon">🔒</span>
                        <span>プライバシーポリシー</span>
                        <span class="legal-arrow">→</span>
                    </button>
                </div>
                <p class="legal-note">本サービスを利用することで、利用規約およびプライバシーポリシーに同意したものとみなされます。</p>
            </div>
        </div>
    </div>
    </div>

    <!-- 共有モーダル -->
    <div id="share-modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2>この教材をシェア</h2>
                <button id="close-share-modal" class="btn-secondary btn-icon">
                    <span style="font-size: 1.2rem;">✕</span>
                </button>
            </div>
            <div class="share-options">
                <button id="copy-url-btn" class="share-option-btn">
                    <span class="share-icon">🔗</span>
                    <div class="share-option-text">
                        <div class="share-option-title">URLをコピー</div>
                        <div class="share-option-desc">クリップボードにコピーして共有</div>
                    </div>
                </button>
                <button id="show-qr-btn" class="share-option-btn">
                    <span class="share-icon">📱</span>
                    <div class="share-option-text">
                        <div class="share-option-title">QRコードを表示</div>
                        <div class="share-option-desc">スマホでスキャンして共有</div>
                    </div>
                </button>
            </div>
            <!-- SNSダイレクトシェアボタン -->
            <div class="share-sns-buttons">
                <button id="share-x-btn" class="share-sns-btn share-x">
                    <span class="sns-icon">𝕏</span>
                    <span>でシェア</span>
                </button>
                <button id="share-line-btn" class="share-sns-btn share-line">
                    <span class="sns-icon">💬</span>
                    <span>LINEでシェア</span>
                </button>
            </div>
            <div id="share-result" class="share-result hidden">
                <div id="share-success" class="share-message hidden">
                    <span class="success-icon">✓</span>
                    <span>URLをコピーしました！</span>
                </div>
                <div id="qr-code-container" class="qr-container hidden">
                    <div id="qr-code"></div>
                    <p class="qr-hint">QRコードをスキャンしてください</p>
                </div>
            </div>
        </div>
    </div>
    </div>

    <!-- 削除確認モーダル -->
    <div id="delete-modal" class="modal hidden">
        <div class="modal-content delete-modal-content">
            <div class="modal-header">
                <h2>🗑️ 教材を削除</h2>
                <button id="close-delete-modal" class="btn-close">✕</button>
            </div>
            <div class="delete-modal-body">
                <p>「<span id="delete-modal-title"></span>」を削除しますか？</p>
                <div class="delete-options">
                    <button id="delete-device-btn" class="delete-option-btn device">
                        <span class="delete-icon">📱</span>
                        <div class="delete-option-text">
                            <div class="delete-option-title">この端末から削除</div>
                            <div class="delete-option-desc">クラウドには残ります。他の端末では引き続き利用できます。</div>
                        </div>
                    </button>
                    <button id="delete-cloud-btn" class="delete-option-btn cloud">
                        <span class="delete-icon">☁️</span>
                        <div class="delete-option-text">
                            <div class="delete-option-title">完全に削除</div>
                            <div class="delete-option-desc">クラウドと全端末から削除されます。この操作は取り消せません。</div>
                        </div>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Generation Settings Modal -->
    <div id="generation-settings-modal" class="modal hidden">
        <div class="modal-content gen-settings-modal-content">
            <div class="modal-header">
                <h2>⚙️ 生成オプション</h2>
                <button id="close-gen-settings-modal" class="btn-close">✕</button>
            </div>
            <div class="setting-group">
                <label class="setting-label">ターゲットレベル</label>
                <div id="level-buttons" class="level-button-group">
                    <button class="level-btn" data-value="初級">🌱 初級</button>
                    <button class="level-btn active" data-value="一般">📚 一般</button>
                    <button class="level-btn" data-value="中級">🎯 中級</button>
                    <button class="level-btn" data-value="上級">🔬 上級</button>
                    <button class="level-btn" data-value="子供向け">🧒 子供向け</button>
                </div>
            </div>
            <div class="setting-group">
                <label class="setting-label">カスタム指示 (任意)</label>
                <textarea id="gen-setting-instructions" class="gen-textarea" rows="3"
                    placeholder="例: 受験勉強用に重要な年号を中心に作ってください..."></textarea>
            </div>
            <div class="setting-group">
                <label class="setting-label">出力言語</label>
                <div id="lang-buttons" class="level-button-group">
                    <button class="level-btn active" data-value="日本語">🇯🇵 日本語</button>
                    <button class="level-btn" data-value="English">🇺🇸 English</button>
                    <button class="level-btn" data-value="auto">🔄 ソースと同じ</button>
                </div>
            </div>
            <!-- Copyright Confirmation -->
            <div class="content-confirm-section">
                <label class="content-confirm-label">
                    <input type="checkbox" id="copyright-confirm-checkbox">
                    <span class="content-confirm-text">
                        入力したコンテンツは自分が作成したもの、または利用許可を得たものです。
                        <a href="#" id="confirm-terms-link">利用規約</a>に同意します。
                    </span>
                </label>
            </div>
            <div class="setting-actions">
                <button id="confirm-generate-btn" class="btn btn-primary btn-full-width" disabled>🚀 クイズを生成する</button>
            </div>
        </div>
    </div>
    <div id="quiz-preview-modal" class="modal hidden">
        <div class="modal-content preview-modal-content">
            <div class="modal-header">
                <h2>🎉 クイズ生成完了！</h2>
                <button id="close-preview-modal" class="btn-close">✕</button>
            </div>
            <h3 id="preview-title" class="preview-title"></h3>
            <div id="preview-grid" class="preview-grid">
                <!-- Preview cards will be inserted here -->
            </div>
            <div class="preview-actions">
                <button id="regenerate-images-btn" class="btn btn-secondary">🔄 画像を再生成</button>
                <button id="close-preview-btn" class="btn btn-primary">✓ 完了</button>
            </div>
        </div>
    </div>

    <!-- Report Modal -->
    <div id="report-modal" class="modal hidden">
        <div class="modal-content report-modal-content">
            <div class="modal-header">
                <h2>🚩 コンテンツを報告</h2>
                <button id="close-report-modal" class="btn-close">✕</button>
            </div>
            <p class="report-target-info">報告対象: <strong id="report-target-title"></strong></p>
            <p class="report-description">不適切なコンテンツや著作権侵害の疑いがある場合は、以下から理由を選択して報告してください。</p>
            <div class="report-options">
                <label class="report-option">
                    <input type="radio" name="report-reason" value="copyright">
                    <span>著作権侵害の疑い</span>
                </label>
                <label class="report-option">
                    <input type="radio" name="report-reason" value="inappropriate">
                    <span>不適切なコンテンツ</span>
                </label>
                <label class="report-option">
                    <input type="radio" name="report-reason" value="spam">
                    <span>スパム・宣伝目的</span>
                </label>
                <label class="report-option">
                    <input type="radio" name="report-reason" value="other">
                    <span>その他</span>
                </label>
            </div>
            <button id="submit-report-btn" class="btn btn-danger report-submit-btn">報告を送信</button>
        </div>
    </div>

    <script>
        // PDF.jsのworkerを設定
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
    <script type="module" src="main.js"></script>
</body>

</html>